<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheRealLofty | Pro Spectrum Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #050505; }
        .lcd-text { font-family: 'Courier New', Courier, monospace; }
        /* Smooth RTA bars */
        .bar { transition: height 0.05s ease-out; }
        input[type=range].vertical {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            width: 15px;
            height: 100%;
        }
    </style>
</head>
<body class="text-emerald-500 flex flex-col items-center justify-center min-h-screen p-4 overflow-hidden">

    <div class="w-full max-w-5xl bg-zinc-900 border-b-8 border-zinc-950 rounded-3xl p-6 shadow-2xl">
        
        <div class="flex justify-between items-center mb-6 bg-black p-4 rounded-xl border border-zinc-800 shadow-inner">
            <div class="flex gap-8">
                <div>
                    <p class="text-[10px] text-zinc-500 uppercase font-bold">Signal Level</p>
                    <p id="db-display" class="text-2xl font-black lcd-text">-- dB</p>
                </div>
                <div>
                    <p class="text-[10px] text-zinc-500 uppercase font-bold">Saturation</p>
                    <p id="sponge-pct" class="text-2xl font-black lcd-text">0%</p>
                </div>
            </div>
            <div class="text-right">
                <h1 class="text-xl font-black tracking-tighter text-zinc-100 uppercase italic">Spectrum Analyzer <span class="text-emerald-500">v2.0</span></h1>
                <p class="text-[9px] text-zinc-500 tracking-[0.3em]">NORTH NOWRA ACOUSTIC LAB</p>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-6 h-[400px]">
            
            <div class="col-span-1 flex flex-col items-center py-4 bg-black rounded-2xl border border-zinc-800">
                <span class="text-[9px] mb-2 uppercase font-bold">Gain</span>
                <input type="range" id="gain" min="0.1" max="4.0" step="0.1" value="1.0" class="vertical accent-emerald-500">
            </div>

            <div class="col-span-8 bg-black rounded-2xl border border-zinc-800 relative p-4 overflow-hidden shadow-inner">
                <canvas id="spectrumCanvas" class="w-full h-full"></canvas>
                <div id="threshold-line" class="absolute left-0 w-full border-t border-dashed border-red-500/50 z-20 pointer-events-none" style="top: 30%;"></div>
            </div>

            <div class="col-span-3 flex flex-col gap-4">
                <div class="flex-1 bg-black rounded-2xl border border-zinc-800 p-4 flex flex-col items-center justify-center">
                    <span class="text-[10px] text-zinc-500 font-bold mb-2 uppercase">Strikes</span>
                    <div id="tally" class="text-8xl font-black text-white italic tracking-tighter">0</div>
                </div>
                
                <div class="h-1/3 bg-black rounded-2xl border border-zinc-800 relative overflow-hidden">
                    <div id="sponge-fill" class="absolute bottom-0 w-full bg-emerald-600 transition-all duration-300" style="height: 0%"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-[10px] font-black text-white mix-blend-difference">SPONGE LEVEL</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-4 mt-6">
            <div class="col-span-2 bg-black p-4 rounded-xl border border-zinc-800 flex flex-col justify-center">
                <div class="flex justify-between text-[10px] font-bold mb-2 uppercase">
                    <span>Sensitivity Threshold</span>
                    <span id="threshold-val">30%</span>
                </div>
                <input type="range" id="threshold" min="5" max="95" value="30" class="w-full accent-emerald-500">
            </div>
            
            <button id="startBtn" class="bg-emerald-600 hover:bg-emerald-500 text-black font-black rounded-xl uppercase tracking-widest transition-all active:scale-95 shadow-[0_0_15px_rgba(16,185,129,0.3)]">
                Initialize Audio
            </button>
            
            <button id="resetBtn" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-400 font-bold rounded-xl uppercase text-xs">
                Clear System
            </button>
        </div>
    </div>

    <script>
        let audioCtx, analyser, dataArray, canvas, canvasCtx;
        let sponge = 0, tallyCount = 0, isTripped = false;

        const startBtn = document.getElementById('startBtn');
        const spongeFill = document.getElementById('sponge-fill');
        const tallyDisplay = document.getElementById('tally');
        const dbDisplay = document.getElementById('db-display');
        const spongeDisplay = document.getElementById('sponge-pct');
        const gainIn = document.getElementById('gain');
        const thresholdIn = document.getElementById('threshold');
        const thresholdLine = document.getElementById('threshold-line');

        // Setup Canvas
        canvas = document.getElementById('spectrumCanvas');
        canvasCtx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        window.onresize = resizeCanvas;
        resizeCanvas();

        async function init() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const source = audioCtx.createMediaStreamSource(stream);
            
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 128; // Number of bars
            source.connect(analyser);
            
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            startBtn.disabled = true;
            startBtn.innerText = "SYSTEM LIVE";
            startBtn.classList.replace('bg-emerald-600', 'bg-zinc-800');
            startBtn.classList.replace('text-black', 'text-zinc-500');
            
            draw();
        }

        function draw() {
            requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);
            
            // UI Synced Values
            const gain = parseFloat(gainIn.value);
            const threshold = parseInt(thresholdIn.value);
            thresholdLine.style.top = (100 - threshold) + '%';
            document.getElementById('threshold-val').innerText = threshold + '%';

            // Clear Canvas
            canvasCtx.fillStyle = 'black';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

            let barWidth = (canvas.width / dataArray.length) * 2.5;
            let barHeight;
            let x = 0;
            let totalVolume = 0;

            for (let i = 0; i < dataArray.length; i++) {
                barHeight = (dataArray[i] * gain);
                totalVolume += barHeight;

                // Gradient color for bars
                let hue = 150 + (i * 2); 
                canvasCtx.fillStyle = `hsla(${hue}, 80%, 50%, 0.8)`;
                
                // Draw Bar
                canvasCtx.fillRect(x, canvas.height - barHeight, barWidth - 2, barHeight);
                x += barWidth;
            }

            // Average Volume (for sponge logic)
            let avgVol = (totalVolume / dataArray.length);
            let volPct = Math.min((avgVol / 255) * 100 * 2, 100);
            
            dbDisplay.innerText = Math.round(avgVol) + " dB";

            // SPONGE LOGIC
            if (volPct > threshold) {
                sponge += (volPct - threshold) * 0.1;
                spongeFill.classList.add('bg-red-500');
            } else {
                sponge -= 0.4;
                spongeFill.classList.remove('bg-red-500');
                spongeFill.classList.add('bg-emerald-600');
            }

            sponge = Math.max(0, Math.min(100, sponge));
            spongeFill.style.height = sponge + '%';
            spongeDisplay.innerText = Math.round(sponge) + "%";

            // TALLY TRIGGER
            if (sponge >= 100 && !isTripped) {
                tallyCount++;
                tallyDisplay.innerText = tallyCount;
                isTripped = true;
                if (navigator.vibrate) navigator.vibrate(200);
            } else if (sponge < 30) {
                isTripped = false;
            }
        }

        startBtn.onclick = init;
        document.getElementById('resetBtn').onclick = () => {
            tallyCount = 0;
            sponge = 0;
            tallyDisplay.innerText = '0';
        };
    </script>
</body>
</html>
